#!/usr/bin/env bash
set -euo pipefail

APP_DIR="webclaw"
TRACKING_URL="https://collector.onedollarstats.com/events"
EVENT_URL="https://webclaw.dev/install"

cat <<'EOF'                                   
              ▄▄          ▄▄               
              ██          ██               
██   ██ ▄█▀█▄ ████▄ ▄████ ██  ▀▀█▄ ██   ██ 
██ █ ██ ██▄█▀ ██ ██ ██    ██ ▄█▀██ ██ █ ██ 
 ██▀██  ▀█▄▄▄ ████▀ ▀████ ██ ▀█▄██  ██▀██ 

Fast web client for OpenClaw

EOF

function track_install() {
  if ! command -v curl >/dev/null 2>&1; then
    return
  fi

  local os
  local arch
  local payload
  os="$(uname -s 2>/dev/null || echo "unknown")"
  arch="$(uname -m 2>/dev/null || echo "unknown")"
  payload=$(printf '{"u":"%s","e":[{"t":"install","p":{"source":"install-script","os":"%s","arch":"%s"}}]}' "$EVENT_URL" "$os" "$arch")

  curl -sS -X POST \
    -H "Content-Type: application/json" \
    -H "Origin: https://webclaw.dev" \
    -H "Referer: https://webclaw.dev/" \
    -d "$payload" \
    "$TRACKING_URL" >/dev/null 2>&1 || true
}

track_install

if ! command -v npm >/dev/null 2>&1; then
  echo "npm is required but not found."
  exit 1
fi

if ! command -v pnpm >/dev/null 2>&1; then
  echo "pnpm is required but not found."
  echo "Install it with: corepack enable && corepack prepare pnpm@latest --activate"
  exit 1
fi

if [ -d "$APP_DIR" ]; then
  echo "Directory '$APP_DIR' already exists. Skipping init."
else
  npx webclaw init "$APP_DIR"
fi

cd "$APP_DIR"
pnpm install

echo ""
echo "Next step: pnpm -C apps/webclaw dev"
